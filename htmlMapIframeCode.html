<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    
    /* Main layout container */
    #main-container { display: flex; flex-direction: column; }
    #map-row { display: flex; }
    #map { flex: 1; height: 500px; z-index: 0; }
    
    /* Unassigned panel - right side */
    #unassigned-panel {
      width: 280px;
      height: 500px;
      background: #fff8e1;
      border-left: 3px solid #ff9800;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      display: none; /* Hidden by default, shown when unassigned exist */
    }
    #unassigned-panel.visible { display: block; }
    #unassigned-panel h3 {
      margin: 0 0 5px 0;
      color: #e65100;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #unassigned-panel h3 .count {
      background: #ff5722;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .unassigned-group {
      margin-bottom: 12px;
    }
    .unassigned-group-header {
      font-weight: bold;
      font-size: 12px;
      color: #666;
      border-bottom: 1px solid #ddd;
      padding-bottom: 3px;
      margin-bottom: 5px;
    }
    .unassigned-item {
      cursor: pointer;
      padding: 4px 8px;
      margin: 2px 0;
      background: #fff;
      border: 1px solid #ffcc80;
      border-radius: 3px;
      font-size: 13px;
      transition: background 0.2s;
    }
    .unassigned-item:hover {
      background: #ffe0b2;
    }
    
    /* Flash animation for highlighted ZIP */
    @keyframes flash-border {
      0%, 100% { 
        stroke: #ff5722;
        stroke-width: 4;
        stroke-opacity: 1;
      }
      50% { 
        stroke: #ffeb3b;
        stroke-width: 6;
        stroke-opacity: 1;
      }
    }
    .flash-highlight {
      animation: flash-border 0.5s ease-in-out 4;
    }
    
    /* Locations panel */
    #locations { width: 90%; margin: 20px auto; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .location { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
    .active { background-color: #d0ebff; }
    .zip-list { margin-top: 5px; font-size: 14px; }
    #controls { padding: 10px; text-align: center; }
    #loading {
      display: none;
      text-align: center;
      padding: 10px;
      font-size: 16px;
      color: #333;
      animation: blink 1.2s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="controls">
      <label for="zipResSlider">ZIP Resolution:</label>
      <input type="range" id="zipResSlider" min="3" max="5" step="2" value="3" />
      <span id="zipResValue">3</span>
    </div>
    <div id="loading">Loading map data...</div>
    <div id="map-row">
      <div id="map"></div>
      <div id="unassigned-panel">
        <h3>⚠️ Unassigned Areas <span class="count" id="unassigned-count">0</span></h3>
        <div id="unassigned-list"></div>
      </div>
    </div>
    <div id="locations"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let zipMap = {};
    let siteData = [];
    let locations = [];
    let selectedLocation = null;
    let geojsonLayers = {};
    let markerLayer = L.layerGroup();
    let locationColors = {};
    let zipResolution = 3;
    
    // Track all ZIP5 features for unassigned detection
    let allZip5Features = {};  // { zip5: { feature, layer } }
    
    // ZIP3 prefix to region name mapping (approximate US regions)
    const zip3ToRegion = {
      // Northeast
      '010': 'MA', '011': 'MA', '012': 'MA', '013': 'MA', '014': 'MA', '015': 'MA', '016': 'MA', '017': 'MA', '018': 'MA', '019': 'MA',
      '020': 'MA', '021': 'MA', '022': 'MA', '023': 'MA', '024': 'MA', '025': 'MA', '026': 'MA', '027': 'MA',
      '028': 'RI', '029': 'RI',
      '030': 'NH', '031': 'NH', '032': 'NH', '033': 'NH', '034': 'NH', '035': 'NH', '036': 'NH', '037': 'NH', '038': 'NH',
      '039': 'ME', '040': 'ME', '041': 'ME', '042': 'ME', '043': 'ME', '044': 'ME', '045': 'ME', '046': 'ME', '047': 'ME', '048': 'ME', '049': 'ME',
      '050': 'VT', '051': 'VT', '052': 'VT', '053': 'VT', '054': 'VT', '055': 'VT', '056': 'VT', '057': 'VT', '058': 'VT', '059': 'VT',
      '060': 'CT', '061': 'CT', '062': 'CT', '063': 'CT', '064': 'CT', '065': 'CT', '066': 'CT', '067': 'CT', '068': 'CT', '069': 'CT',
      '070': 'NJ', '071': 'NJ', '072': 'NJ', '073': 'NJ', '074': 'NJ', '075': 'NJ', '076': 'NJ', '077': 'NJ', '078': 'NJ', '079': 'NJ',
      '080': 'NJ', '081': 'NJ', '082': 'NJ', '083': 'NJ', '084': 'NJ', '085': 'NJ', '086': 'NJ', '087': 'NJ', '088': 'NJ', '089': 'NJ',
      // New York
      '100': 'NY', '101': 'NY', '102': 'NY', '103': 'NY', '104': 'NY', '105': 'NY', '106': 'NY', '107': 'NY', '108': 'NY', '109': 'NY',
      '110': 'NY', '111': 'NY', '112': 'NY', '113': 'NY', '114': 'NY', '115': 'NY', '116': 'NY', '117': 'NY', '118': 'NY', '119': 'NY',
      '120': 'NY', '121': 'NY', '122': 'NY', '123': 'NY', '124': 'NY', '125': 'NY', '126': 'NY', '127': 'NY', '128': 'NY', '129': 'NY',
      '130': 'NY', '131': 'NY', '132': 'NY', '133': 'NY', '134': 'NY', '135': 'NY', '136': 'NY', '137': 'NY', '138': 'NY', '139': 'NY',
      '140': 'NY', '141': 'NY', '142': 'NY', '143': 'NY', '144': 'NY', '145': 'NY', '146': 'NY', '147': 'NY', '148': 'NY', '149': 'NY',
      // Pennsylvania
      '150': 'PA', '151': 'PA', '152': 'PA', '153': 'PA', '154': 'PA', '155': 'PA', '156': 'PA', '157': 'PA', '158': 'PA', '159': 'PA',
      '160': 'PA', '161': 'PA', '162': 'PA', '163': 'PA', '164': 'PA', '165': 'PA', '166': 'PA', '167': 'PA', '168': 'PA', '169': 'PA',
      '170': 'PA', '171': 'PA', '172': 'PA', '173': 'PA', '174': 'PA', '175': 'PA', '176': 'PA', '177': 'PA', '178': 'PA', '179': 'PA',
      '180': 'PA', '181': 'PA', '182': 'PA', '183': 'PA', '184': 'PA', '185': 'PA', '186': 'PA', '187': 'PA', '188': 'PA', '189': 'PA',
      '190': 'PA', '191': 'PA', '192': 'PA', '193': 'PA', '194': 'PA', '195': 'PA', '196': 'PA',
      // Delaware, DC, Maryland, Virginia, West Virginia
      '197': 'DE', '198': 'DE', '199': 'DE',
      '200': 'DC', '201': 'VA', '202': 'DC', '203': 'DC', '204': 'DC', '205': 'DC',
      '206': 'MD', '207': 'MD', '208': 'MD', '209': 'MD', '210': 'MD', '211': 'MD', '212': 'MD', '214': 'MD', '215': 'MD', '216': 'MD', '217': 'MD', '218': 'MD', '219': 'MD',
      '220': 'VA', '221': 'VA', '222': 'VA', '223': 'VA', '224': 'VA', '225': 'VA', '226': 'VA', '227': 'VA', '228': 'VA', '229': 'VA',
      '230': 'VA', '231': 'VA', '232': 'VA', '233': 'VA', '234': 'VA', '235': 'VA', '236': 'VA', '237': 'VA', '238': 'VA', '239': 'VA',
      '240': 'VA', '241': 'VA', '242': 'VA', '243': 'VA', '244': 'VA', '245': 'VA', '246': 'VA',
      '247': 'WV', '248': 'WV', '249': 'WV', '250': 'WV', '251': 'WV', '252': 'WV', '253': 'WV', '254': 'WV', '255': 'WV', '256': 'WV', '257': 'WV', '258': 'WV', '259': 'WV',
      '260': 'WV', '261': 'WV', '262': 'WV', '263': 'WV', '264': 'WV', '265': 'WV', '266': 'WV', '267': 'WV', '268': 'WV',
      // North Carolina, South Carolina
      '270': 'NC', '271': 'NC', '272': 'NC', '273': 'NC', '274': 'NC', '275': 'NC', '276': 'NC', '277': 'NC', '278': 'NC', '279': 'NC',
      '280': 'NC', '281': 'NC', '282': 'NC', '283': 'NC', '284': 'NC', '285': 'NC', '286': 'NC', '287': 'NC', '288': 'NC', '289': 'NC',
      '290': 'SC', '291': 'SC', '292': 'SC', '293': 'SC', '294': 'SC', '295': 'SC', '296': 'SC', '297': 'SC', '298': 'SC', '299': 'SC',
      // Georgia, Florida
      '300': 'GA', '301': 'GA', '302': 'GA', '303': 'GA', '304': 'GA', '305': 'GA', '306': 'GA', '307': 'GA', '308': 'GA', '309': 'GA',
      '310': 'GA', '311': 'GA', '312': 'GA', '313': 'GA', '314': 'GA', '315': 'GA', '316': 'GA', '317': 'GA', '318': 'GA', '319': 'GA',
      '320': 'FL', '321': 'FL', '322': 'FL', '323': 'FL', '324': 'FL', '325': 'FL', '326': 'FL', '327': 'FL', '328': 'FL', '329': 'FL',
      '330': 'FL', '331': 'FL', '332': 'FL', '333': 'FL', '334': 'FL', '335': 'FL', '336': 'FL', '337': 'FL', '338': 'FL', '339': 'FL',
      '340': 'FL', '341': 'FL', '342': 'FL', '344': 'FL', '346': 'FL', '347': 'FL', '349': 'FL',
      // Alabama, Tennessee, Mississippi
      '350': 'AL', '351': 'AL', '352': 'AL', '354': 'AL', '355': 'AL', '356': 'AL', '357': 'AL', '358': 'AL', '359': 'AL',
      '360': 'AL', '361': 'AL', '362': 'AL', '363': 'AL', '364': 'AL', '365': 'AL', '366': 'AL', '367': 'AL', '368': 'AL', '369': 'AL',
      '370': 'TN', '371': 'TN', '372': 'TN', '373': 'TN', '374': 'TN', '375': 'TN', '376': 'TN', '377': 'TN', '378': 'TN', '379': 'TN',
      '380': 'TN', '381': 'TN', '382': 'TN', '383': 'TN', '384': 'TN', '385': 'TN',
      '386': 'MS', '387': 'MS', '388': 'MS', '389': 'MS', '390': 'MS', '391': 'MS', '392': 'MS', '393': 'MS', '394': 'MS', '395': 'MS', '396': 'MS', '397': 'MS',
      // Kentucky, Ohio
      '400': 'KY', '401': 'KY', '402': 'KY', '403': 'KY', '404': 'KY', '405': 'KY', '406': 'KY', '407': 'KY', '408': 'KY', '409': 'KY',
      '410': 'KY', '411': 'KY', '412': 'KY', '413': 'KY', '414': 'KY', '415': 'KY', '416': 'KY', '417': 'KY', '418': 'KY',
      '420': 'KY', '421': 'KY', '422': 'KY', '423': 'KY', '424': 'KY', '425': 'KY', '426': 'KY', '427': 'KY',
      '430': 'OH', '431': 'OH', '432': 'OH', '433': 'OH', '434': 'OH', '435': 'OH', '436': 'OH', '437': 'OH', '438': 'OH', '439': 'OH',
      '440': 'OH', '441': 'OH', '442': 'OH', '443': 'OH', '444': 'OH', '445': 'OH', '446': 'OH', '447': 'OH', '448': 'OH', '449': 'OH',
      '450': 'OH', '451': 'OH', '452': 'OH', '453': 'OH', '454': 'OH', '455': 'OH', '456': 'OH', '457': 'OH', '458': 'OH',
      // Indiana, Michigan
      '460': 'IN', '461': 'IN', '462': 'IN', '463': 'IN', '464': 'IN', '465': 'IN', '466': 'IN', '467': 'IN', '468': 'IN', '469': 'IN',
      '470': 'IN', '471': 'IN', '472': 'IN', '473': 'IN', '474': 'IN', '475': 'IN', '476': 'IN', '477': 'IN', '478': 'IN', '479': 'IN',
      '480': 'MI', '481': 'MI', '482': 'MI', '483': 'MI', '484': 'MI', '485': 'MI', '486': 'MI', '487': 'MI', '488': 'MI', '489': 'MI',
      '490': 'MI', '491': 'MI', '492': 'MI', '493': 'MI', '494': 'MI', '495': 'MI', '496': 'MI', '497': 'MI', '498': 'MI', '499': 'MI',
      // Iowa, Wisconsin, Minnesota
      '500': 'IA', '501': 'IA', '502': 'IA', '503': 'IA', '504': 'IA', '505': 'IA', '506': 'IA', '507': 'IA', '508': 'IA', '509': 'IA',
      '510': 'IA', '511': 'IA', '512': 'IA', '513': 'IA', '514': 'IA', '515': 'IA', '516': 'IA',
      '520': 'IA', '521': 'IA', '522': 'IA', '523': 'IA', '524': 'IA', '525': 'IA', '526': 'IA', '527': 'IA', '528': 'IA',
      '530': 'WI', '531': 'WI', '532': 'WI', '534': 'WI', '535': 'WI', '537': 'WI', '538': 'WI', '539': 'WI',
      '540': 'WI', '541': 'WI', '542': 'WI', '543': 'WI', '544': 'WI', '545': 'WI', '546': 'WI', '547': 'WI', '548': 'WI', '549': 'WI',
      '550': 'MN', '551': 'MN', '553': 'MN', '554': 'MN', '555': 'MN', '556': 'MN', '557': 'MN', '558': 'MN', '559': 'MN',
      '560': 'MN', '561': 'MN', '562': 'MN', '563': 'MN', '564': 'MN', '565': 'MN', '566': 'MN', '567': 'MN',
      // South Dakota, North Dakota
      '570': 'SD', '571': 'SD', '572': 'SD', '573': 'SD', '574': 'SD', '575': 'SD', '576': 'SD', '577': 'SD',
      '580': 'ND', '581': 'ND', '582': 'ND', '583': 'ND', '584': 'ND', '585': 'ND', '586': 'ND', '587': 'ND', '588': 'ND',
      // Montana, Idaho, Wyoming
      '590': 'MT', '591': 'MT', '592': 'MT', '593': 'MT', '594': 'MT', '595': 'MT', '596': 'MT', '597': 'MT', '598': 'MT', '599': 'MT',
      '820': 'WY', '821': 'WY', '822': 'WY', '823': 'WY', '824': 'WY', '825': 'WY', '826': 'WY', '827': 'WY', '828': 'WY', '829': 'WY', '830': 'WY', '831': 'WY',
      '832': 'ID', '833': 'ID', '834': 'ID', '835': 'ID', '836': 'ID', '837': 'ID', '838': 'ID',
      // Illinois
      '600': 'IL', '601': 'IL', '602': 'IL', '603': 'IL', '604': 'IL', '605': 'IL', '606': 'IL', '607': 'IL', '608': 'IL', '609': 'IL',
      '610': 'IL', '611': 'IL', '612': 'IL', '613': 'IL', '614': 'IL', '615': 'IL', '616': 'IL', '617': 'IL', '618': 'IL', '619': 'IL',
      '620': 'IL', '622': 'IL', '623': 'IL', '624': 'IL', '625': 'IL', '626': 'IL', '627': 'IL', '628': 'IL', '629': 'IL',
      // Missouri, Kansas
      '630': 'MO', '631': 'MO', '633': 'MO', '634': 'MO', '635': 'MO', '636': 'MO', '637': 'MO', '638': 'MO', '639': 'MO',
      '640': 'MO', '641': 'MO', '644': 'MO', '645': 'MO', '646': 'MO', '647': 'MO', '648': 'MO', '649': 'MO',
      '650': 'MO', '651': 'MO', '652': 'MO', '653': 'MO', '654': 'MO', '655': 'MO', '656': 'MO', '657': 'MO', '658': 'MO',
      '660': 'KS', '661': 'KS', '662': 'KS', '664': 'KS', '665': 'KS', '666': 'KS', '667': 'KS', '668': 'KS', '669': 'KS',
      '670': 'KS', '671': 'KS', '672': 'KS', '673': 'KS', '674': 'KS', '675': 'KS', '676': 'KS', '677': 'KS', '678': 'KS', '679': 'KS',
      // Nebraska
      '680': 'NE', '681': 'NE', '683': 'NE', '684': 'NE', '685': 'NE', '686': 'NE', '687': 'NE', '688': 'NE', '689': 'NE',
      '690': 'NE', '691': 'NE', '692': 'NE', '693': 'NE',
      // Louisiana, Arkansas
      '700': 'LA', '701': 'LA', '703': 'LA', '704': 'LA', '705': 'LA', '706': 'LA', '707': 'LA', '708': 'LA',
      '710': 'LA', '711': 'LA', '712': 'LA', '713': 'LA', '714': 'LA',
      '716': 'AR', '717': 'AR', '718': 'AR', '719': 'AR', '720': 'AR', '721': 'AR', '722': 'AR', '723': 'AR', '724': 'AR', '725': 'AR', '726': 'AR', '727': 'AR', '728': 'AR', '729': 'AR',
      // Oklahoma
      '730': 'OK', '731': 'OK', '734': 'OK', '735': 'OK', '736': 'OK', '737': 'OK', '738': 'OK', '739': 'OK',
      '740': 'OK', '741': 'OK', '743': 'OK', '744': 'OK', '745': 'OK', '746': 'OK', '747': 'OK', '748': 'OK', '749': 'OK',
      // Texas
      '750': 'TX', '751': 'TX', '752': 'TX', '753': 'TX', '754': 'TX', '755': 'TX', '756': 'TX', '757': 'TX', '758': 'TX', '759': 'TX',
      '760': 'TX', '761': 'TX', '762': 'TX', '763': 'TX', '764': 'TX', '765': 'TX', '766': 'TX', '767': 'TX', '768': 'TX', '769': 'TX',
      '770': 'TX', '772': 'TX', '773': 'TX', '774': 'TX', '775': 'TX', '776': 'TX', '777': 'TX', '778': 'TX', '779': 'TX',
      '780': 'TX', '781': 'TX', '782': 'TX', '783': 'TX', '784': 'TX', '785': 'TX', '786': 'TX', '787': 'TX', '788': 'TX', '789': 'TX',
      '790': 'TX', '791': 'TX', '792': 'TX', '793': 'TX', '794': 'TX', '795': 'TX', '796': 'TX', '797': 'TX', '798': 'TX', '799': 'TX',
      // Colorado
      '800': 'CO', '801': 'CO', '802': 'CO', '803': 'CO', '804': 'CO', '805': 'CO', '806': 'CO', '807': 'CO', '808': 'CO', '809': 'CO',
      '810': 'CO', '811': 'CO', '812': 'CO', '813': 'CO', '814': 'CO', '815': 'CO', '816': 'CO',
      // New Mexico, Arizona
      '870': 'NM', '871': 'NM', '872': 'NM', '873': 'NM', '874': 'NM', '875': 'NM', '877': 'NM', '878': 'NM', '879': 'NM',
      '880': 'NM', '881': 'NM', '882': 'NM', '883': 'NM', '884': 'NM',
      '850': 'AZ', '851': 'AZ', '852': 'AZ', '853': 'AZ', '855': 'AZ', '856': 'AZ', '857': 'AZ', '858': 'AZ', '859': 'AZ',
      '860': 'AZ', '863': 'AZ', '864': 'AZ', '865': 'AZ',
      // Utah, Nevada
      '840': 'UT', '841': 'UT', '842': 'UT', '843': 'UT', '844': 'UT', '845': 'UT', '846': 'UT', '847': 'UT',
      '889': 'NV', '890': 'NV', '891': 'NV', '893': 'NV', '894': 'NV', '895': 'NV', '897': 'NV', '898': 'NV',
      // California
      '900': 'CA', '901': 'CA', '902': 'CA', '903': 'CA', '904': 'CA', '905': 'CA', '906': 'CA', '907': 'CA', '908': 'CA',
      '910': 'CA', '911': 'CA', '912': 'CA', '913': 'CA', '914': 'CA', '915': 'CA', '916': 'CA', '917': 'CA', '918': 'CA',
      '919': 'CA', '920': 'CA', '921': 'CA', '922': 'CA', '923': 'CA', '924': 'CA', '925': 'CA', '926': 'CA', '927': 'CA', '928': 'CA',
      '930': 'CA', '931': 'CA', '932': 'CA', '933': 'CA', '934': 'CA', '935': 'CA', '936': 'CA', '937': 'CA', '938': 'CA', '939': 'CA',
      '940': 'CA', '941': 'CA', '942': 'CA', '943': 'CA', '944': 'CA', '945': 'CA', '946': 'CA', '947': 'CA', '948': 'CA', '949': 'CA',
      '950': 'CA', '951': 'CA', '952': 'CA', '953': 'CA', '954': 'CA', '955': 'CA', '956': 'CA', '957': 'CA', '958': 'CA', '959': 'CA',
      '960': 'CA', '961': 'CA',
      // Hawaii, Alaska
      '967': 'HI', '968': 'HI',
      '995': 'AK', '996': 'AK', '997': 'AK', '998': 'AK', '999': 'AK',
      // Oregon, Washington
      '970': 'OR', '971': 'OR', '972': 'OR', '973': 'OR', '974': 'OR', '975': 'OR', '976': 'OR', '977': 'OR', '978': 'OR', '979': 'OR',
      '980': 'WA', '981': 'WA', '982': 'WA', '983': 'WA', '984': 'WA', '985': 'WA', '986': 'WA', '988': 'WA', '989': 'WA',
      '990': 'WA', '991': 'WA', '992': 'WA', '993': 'WA', '994': 'WA'
    };
    
    // State names for display
    const stateNames = {
      'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
      'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'DC': 'Washington DC', 'FL': 'Florida',
      'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana',
      'IA': 'Iowa', 'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
      'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
      'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire',
      'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota',
      'OH': 'Ohio', 'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
      'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
      'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
    };

    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.createPane('zipPane');
    map.getPane('zipPane').style.zIndex = 200;
    markerLayer.addTo(map);

    document.getElementById("zipResSlider").addEventListener("input", function(e) {
      zipResolution = parseInt(e.target.value);
      document.getElementById("zipResValue").textContent = zipResolution;
      updateVisibleGeoJSONLayers();
    });

    function generateColors(count) {
      const colors = [];
      for (let i = 0; i < count; i++) {
        const hue = Math.floor((360 / count) * i);
        colors.push(`hsl(${hue}, 70%, 60%)`);
      }
      return colors;
    }

    function getZipKey(zip) {
      if (!zip || zip.length < zipResolution) return null;
      return zip.substring(0, zipResolution);
    }

    function resolveZipAssignment(zip5) {
      if (!zip5) return null;
      return zipMap[zip5] ||
             (zip5.length >= 3 ? zipMap[zip5.substring(0, 3)] : null);
    }

    function extractZip(feature) {
      if (!feature.properties) return null;
      const keys = Object.keys(feature.properties);
      for (let key of keys) {
        const value = feature.properties[key];
        if (typeof value === 'string' && /^\d{3,5}$/.test(value)) {
          return value;
        }
      }
      return null;
    }

    function style(feature) {
      const zip5 = extractZip(feature);
      const assigned = resolveZipAssignment(zip5);
      const zipKey = zip5 ? zip5.substring(0, Math.min(5, zip5.length)) : null;
      const styleRes = zipKey ? zipKey.length : 0;
      const showLine = styleRes === zipResolution;
      const showFill = (
        (styleRes <= zipResolution && assigned) ||
        (zipResolution === 3 && styleRes === 5 && assigned)
      );
      return {
        fillColor: showFill ? locationColors[assigned] : 'transparent',
        weight: showLine ? 2 : 0, // Made weight more evident
        color: showLine ? '#555' : 'transparent', // Darker stroke color
        fillOpacity: showFill ? 0.6 : 0,
        pane: 'zipPane'
      };
    }

    function onEachFeature(feature, layer) {
      const zip5 = extractZip(feature);
      layer.on({
        click: () => {
          if (!selectedLocation || !zip5) return;
          const zipKey = getZipKey(zip5);
          if (!zipKey) return;
          if (zipMap[zipKey] === selectedLocation) {
            delete zipMap[zipKey];
          } else {
            zipMap[zipKey] = selectedLocation;
          }
          Object.values(geojsonLayers).forEach(l => l.setStyle(style));
          updateLists();
          postZipMapToParent();
        }
      });
      layer.bindTooltip(`ZIP: ${zip5 || "Unknown"}`, { sticky: true });
    }

    function updateLists() {
      const container = document.getElementById("locations");
      container.innerHTML = "";
      locations.forEach(loc => {
        const div = document.createElement("div");
        div.className = "location" + (selectedLocation === loc ? " active" : "");
        div.style.borderLeft = `10px solid ${locationColors[loc]}`;
        div.textContent = loc;
        div.addEventListener("click", () => {
          selectedLocation = loc;
          updateLists();
        });
        const assigned = Object.entries(zipMap).filter(([_, l]) => l === loc).map(([z]) => z).sort().join(", ");
        const zipList = document.createElement("div");
        zipList.className = "zip-list";
        zipList.textContent = assigned;
        div.appendChild(zipList);
        container.appendChild(div);
      });
      
      // Update unassigned panel whenever lists update
      updateUnassignedPanel();
    }

    function placeMarkers() {
      markerLayer.clearLayers();
      siteData.forEach(site => {
        const lat = parseFloat(site.latitude);
        const lon = parseFloat(site.longitude);
        if (!isNaN(lat) && !isNaN(lon)) {

const marker = L.circleMarker([lat, lon], {
  radius: 9,                                // slightly larger dot
  color: 'black',                           // BLACK BORDER
  weight: 3,                                // border thickness (px)
  opacity: 1,                               // border opacity
  fillColor: locationColors[site.locationName], // keep your per-location color inside
  fillOpacity: 1                            // solid fill
});


          marker.on('click', () => {
            selectedLocation = site.locationName;
            updateLists();
          });
          marker.bindTooltip(site.locationName);
          marker.addTo(markerLayer);
        }
      });
    }

    function postZipMapToParent() {
      window.parent.postMessage({ type: "zip3MapUpdate", zip3Map: zipMap }, "*");
    }

    // Get all unassigned ZIP5 codes
    function getUnassignedZips() {
      const unassigned = [];
      Object.keys(allZip5Features).forEach(zip5 => {
        const assigned = resolveZipAssignment(zip5);
        if (!assigned) {
          unassigned.push(zip5);
        }
      });
      return unassigned.sort();
    }

    // Group ZIPs by state
    function groupZipsByState(zips) {
      const groups = {};
      zips.forEach(zip => {
        const zip3 = zip.substring(0, 3);
        const state = zip3ToRegion[zip3] || 'Other';
        if (!groups[state]) groups[state] = [];
        groups[state].push(zip);
      });
      // Sort states alphabetically
      const sortedGroups = {};
      Object.keys(groups).sort().forEach(state => {
        sortedGroups[state] = groups[state].sort();
      });
      return sortedGroups;
    }

    // Update the unassigned panel
    function updateUnassignedPanel() {
      const panel = document.getElementById('unassigned-panel');
      const listContainer = document.getElementById('unassigned-list');
      const countEl = document.getElementById('unassigned-count');
      
      const unassigned = getUnassignedZips();
      countEl.textContent = unassigned.length;
      
      if (unassigned.length === 0) {
        panel.classList.remove('visible');
        return;
      }
      
      panel.classList.add('visible');
      listContainer.innerHTML = '';
      
      const grouped = groupZipsByState(unassigned);
      
      Object.entries(grouped).forEach(([state, zips]) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'unassigned-group';
        
        const header = document.createElement('div');
        header.className = 'unassigned-group-header';
        header.textContent = `${stateNames[state] || state} (${zips.length})`;
        groupDiv.appendChild(header);
        
        zips.forEach(zip => {
          const item = document.createElement('div');
          item.className = 'unassigned-item';
          item.textContent = zip;
          item.addEventListener('click', () => zoomAndFlash(zip));
          groupDiv.appendChild(item);
        });
        
        listContainer.appendChild(groupDiv);
      });
    }

    // Zoom to a ZIP and flash it
    function zoomAndFlash(zip5) {
      const featureData = allZip5Features[zip5];
      if (!featureData || !featureData.layer) return;
      
      const layer = featureData.layer;
      const bounds = layer.getBounds();
      
      // Zoom to the area with some padding
      map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
      
      // Flash the layer
      flashLayer(layer);
    }

    // Flash animation for a layer
    function flashLayer(layer) {
      let flashCount = 0;
      const maxFlashes = 4;
      const flashInterval = 250; // ms per half-cycle
      
      const originalStyle = {
        color: '#555',
        weight: 2,
        fillOpacity: 0.6
      };
      
      const flashStyle = {
        color: '#ff5722',
        weight: 5,
        fillColor: '#ffeb3b',
        fillOpacity: 0.8
      };
      
      const flash = () => {
        if (flashCount >= maxFlashes * 2) {
          // Reset to original style
          layer.setStyle(style(layer.feature));
          return;
        }
        
        if (flashCount % 2 === 0) {
          layer.setStyle(flashStyle);
        } else {
          layer.setStyle(originalStyle);
        }
        
        flashCount++;
        setTimeout(flash, flashInterval);
      };
      
      flash();
    }

    async function loadGeoJSON(res) {
      const fileMap = {
        3: "https://502226b4-110a-4861-ad7e-941df81678ff.usrfiles.com/ugd/502226_607f9c6b831d4302a2f993ac0d3fcb1b.json",
        5: "https://502226b4-110a-4861-ad7e-941df81678ff.usrfiles.com/ugd/502226_2549809086954acebd6ec068454354e8.json"
      };
      const url = fileMap[res];
      try {
        const geojsonResp = await fetch(url);
        const geojson = await geojsonResp.json();
        const layer = L.geoJSON(geojson, {
          style,
          onEachFeature: (feature, layer) => {
            // Store ZIP5 features for unassigned tracking
            const zip5 = extractZip(feature);
            if (zip5 && zip5.length === 5 && res === 5) {
              allZip5Features[zip5] = { feature, layer };
            }
            // Call original onEachFeature
            onEachFeature(feature, layer);
          }
        });
        geojsonLayers[res] = layer;
      } catch (err) {
        console.error(`Error loading GeoJSON for resolution ${res}:`, err);
      }
    }

    function updateVisibleGeoJSONLayers() {
      const loadingEl = document.getElementById("loading");
      loadingEl.style.display = "block";
      Object.entries(geojsonLayers).forEach(([res, layer]) => {
        if (map.hasLayer(layer)) map.removeLayer(layer);
      });
      Object.entries(geojsonLayers).forEach(([res, layer]) => {
        const resNum = parseInt(res);
        if (resNum === 3 || resNum === 5) {
          if (zipResolution === 3 || zipResolution === 5) {
            layer.setStyle(style);
            layer.addTo(map);
          }
        }
      });
      map.eachLayer(layer => {
        if (layer === markerLayer) {
          markerLayer.eachLayer(m => m.bringToFront());
        }
      });
      loadingEl.style.display = "none";
    }

    window.addEventListener("message", async (event) => {
      if (!event.data || event.data.type !== "initMap") return;
      const { sites, initialMap } = event.data;
      siteData = sites;
      zipMap = initialMap || {};
      locations = [...new Set(siteData.map(d => d.locationName))];
      const palette = generateColors(locations.length);
      locationColors = Object.fromEntries(locations.map((loc, i) => [loc, palette[i]]));
      updateLists();
      placeMarkers();
      await Promise.all([loadGeoJSON(3), loadGeoJSON(5)]);
      updateVisibleGeoJSONLayers();
      // Update unassigned panel after all data is loaded
      updateUnassignedPanel();
    });
  </script>
</body>
</html>
